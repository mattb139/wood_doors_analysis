<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residential Jobs Customer Analysis Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #f0f4ff;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .analysis-section {
            display: none;
        }
        
        .analysis-section.active {
            display: block;
        }
        
        .processing-info {
            background: #d1f2eb;
            border: 1px solid #0f5132;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0a4027;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }
        
        .filter-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            user-select: none;
        }
        
        th.sortable {
            cursor: pointer;
        }
        
        th.sortable:hover {
            background: linear-gradient(135deg, #7c8ff0 0%, #8759a8 100%);
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .customer-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .type-homeowner {
            background: #d1f2eb;
            color: #0f5132;
        }
        
        .type-contractor {
            background: #fff3cd;
            color: #856404;
        }
        
        .service-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 4px;
            background: #e7f5ff;
            color: #0c63e4;
        }
        
        .product-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 4px;
            background: #f8e7ff;
            color: #6f42c1;
        }
        
        .job-link {
            color: #667eea;
            text-decoration: none;
            margin-right: 6px;
            padding: 2px 6px;
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 3px;
            display: inline-block;
            transition: all 0.2s;
            font-size: 11px;
        }
        
        .job-link:hover {
            background: #667eea;
            color: white;
        }
        
        .categories-summary {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .category-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .category-chip {
            background: #f8f9fa;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Residential Jobs Customer Analysis Tool</h1>
            <p>Enhanced with 2024/2025 garage door industry categorization</p>
        </div>
        
        <div class="content">
            <!-- Upload Section -->
            <div class="upload-area" id="uploadArea">
                <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                <div style="font-size: 18px; margin-bottom: 10px;">Upload Your Complete Job Report CSV</div>
                <div style="color: #6c757d; font-size: 14px;">Automatically filters Residential = Yes and categorizes by service type and products</div>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            
            <!-- Analysis Section -->
            <div class="analysis-section" id="analysisSection">
                <!-- Processing Info -->
                <div class="processing-info">
                    <div style="font-weight: 600; margin-bottom: 5px;">Data Processing Summary</div>
                    <div id="processingInfo"></div>
                </div>
                
                <!-- Categories Summary -->
                <div class="categories-summary" id="categoriesSummary" style="display: none;">
                    <div style="font-weight: 600; margin-bottom: 10px;">Detected Categories</div>
                    <div style="margin-bottom: 10px;">
                        <strong>Service Types:</strong>
                        <div class="category-chips" id="serviceTypeChips"></div>
                    </div>
                    <div>
                        <strong>Product Categories:</strong>
                        <div class="category-chips" id="productCategoryChips"></div>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div class="stats-grid" id="statsGrid"></div>
                
                <!-- Filters -->
                <div class="filters" id="filtersContainer" style="display: none;">
                    <div class="filter-section-title">Basic Filters</div>
                    <div class="filter-row" id="basicFilters"></div>
                    
                    <div class="filter-section-title" style="margin-top: 15px;">Service & Product Filters</div>
                    <div class="filter-row" id="categoryFilters"></div>
                    
                    <div class="filter-section-title" style="margin-top: 15px;">Time & Location Filters</div>
                    <div class="filter-row" id="timeLocationFilters"></div>
                </div>
                
                <!-- Action Buttons -->
                <div class="buttons">
                    <button class="btn btn-primary" onclick="app.exportSummary()">Export Customer Summary</button>
                    <button class="btn btn-primary" onclick="app.exportDetailed()">Export Detailed Report</button>
                    <button class="btn btn-info" onclick="app.showCategoryAnalysis()">Category Analysis</button>
                    <button class="btn btn-secondary" onclick="app.reset()">Upload New File</button>
                </div>
                
                <!-- Data Table -->
                <div class="table-container">
                    <table id="dataTable">
                        <thead id="tableHeader"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Error Display -->
            <div id="errorContainer"></div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        
        const CONFIG = {
            serviceTypes: {
                'install': {
                    keywords: ['install', 'installation', 'new door', 'replacement', 'door installation', 'opener installation'],
                    label: 'Installation'
                },
                'service': {
                    keywords: ['service', 'repair', 'fix', 'adjust', 'alignment', 'troubleshoot', 'service call', 'diagnostic'],
                    label: 'Service/Repair'
                },
                'warranty': {
                    keywords: ['warranty', 'warranty work', 'warranty service', 'warranty repair', 'under warranty', 'covered repair'],
                    label: 'Warranty'
                },
                'spring': {
                    keywords: ['spring', 'torsion', 'extension spring', 'spring repair', 'spring replacement', 'spring install', 'spring adjustment', 'broken spring'],
                    label: 'Spring Service'
                },
                'operator': {
                    keywords: ['operator', 'opener', 'motor', 'remote', 'keypad', 'opener repair', 'opener replacement', 'motor replacement'],
                    label: 'Operator/Opener'
                },
                'maintenance': {
                    keywords: ['tune-up', 'tune up', 'maintenance', 'lubrication', 'inspection', 'preventive', 'annual service', 'cleaning'],
                    label: 'Maintenance'
                },
                'emergency': {
                    keywords: ['emergency', 'urgent', 'after hours', 'same day', 'asap', 'stuck door', 'door won\'t open', 'door won\'t close'],
                    label: 'Emergency'
                },
                'hardware': {
                    keywords: ['roller', 'cable', 'track', 'hinge', 'bracket', 'strut', 'bearing', 'weatherstrip', 'seal', 'bottom seal', 'hardware replacement'],
                    label: 'Hardware'
                }
            },
            
            productCategories: {
                'chi': { keywords: ['chi', 'c.h.i', 'chi overhead', 'chi door', 'chi accent'], label: 'CHI Doors' },
                'clopay': { keywords: ['clopay', 'canyon ridge', 'coachman', 'gallery', 'avante', 'reserve wood', 'classic series'], label: 'Clopay Doors' },
                'amarr': { keywords: ['amarr', 'classica', 'heritage', 'lincoln', 'stratford', 'safeguard', 'weatherguard'], label: 'Amarr Doors' },
                'wayne_dalton': { keywords: ['wayne dalton', 'wayne-dalton', 'torquemaster', 'truchoice', 'insulated series'], label: 'Wayne Dalton' },
                'overhead_door': { keywords: ['overhead door', 'thermacore', 'ribbon series', 'courtyard series'], label: 'Overhead Door' },
                'raynor': { keywords: ['raynor', 'aspen', 'distinction', 'tri-core', 'showcase', 'performance plus'], label: 'Raynor Doors' },
                'haas_door': { keywords: ['haas door', 'haas', 'traditional series', 'carriage collection'], label: 'Haas Door' },
                'hormann': { keywords: ['hormann', 'h√∂rmann', 'german door'], label: 'Hormann Doors' },
                'wood_door': { keywords: ['wood door', 'wooden door', 'cedar', 'redwood', 'hemlock', 'mahogany', 'natural wood', 'solid wood', 'wood overlay'], label: 'Wood Doors' },
                'steel_door': { keywords: ['steel door', 'steel panel', 'insulated steel', 'non-insulated steel', '24 gauge', '25 gauge', 'steel sectional'], label: 'Steel Doors' },
                'aluminum': { keywords: ['aluminum', 'aluminum door', 'full view aluminum', 'aluminum glass', 'anodized aluminum'], label: 'Aluminum Doors' },
                'fiberglass': { keywords: ['fiberglass', 'fiberglass door', 'composite fiberglass'], label: 'Fiberglass Doors' },
                'carriage': { keywords: ['carriage', 'carriage house', 'carriage style', 'overlay carriage', 'barn style', 'barn door', 'faux carriage'], label: 'Carriage House' },
                'modern': { keywords: ['modern', 'contemporary', 'flush panel', 'modern steel', 'modern aluminum', 'sleek design', 'minimalist'], label: 'Modern/Contemporary' },
                'liftmaster': { keywords: ['liftmaster', 'lift master', '8500', '8550', '8360', '8365', 'myq liftmaster', 'elite series'], label: 'LiftMaster' },
                'chamberlain': { keywords: ['chamberlain', 'b970', 'b550', 'b750', 'b2405', 'b6765', 'myq chamberlain', 'whisper drive'], label: 'Chamberlain' },
                'genie': { keywords: ['genie', 'intellig', 'silentmax', 'stealth drive', 'quietlift', 'aladdin connect', 'chain drive 500'], label: 'Genie' },
                'craftsman': { keywords: ['craftsman', 'craftsman opener'], label: 'Craftsman' },
                'springs': { keywords: ['spring', 'torsion spring', 'extension spring', 'maxlife', 'ez-set', 'high cycle springs', 'spring system'], label: 'Springs' },
                'cables': { keywords: ['cable', 'aircraft cable', 'galvanized cable', 'lift cable'], label: 'Cables' },
                'rollers': { keywords: ['roller', 'nylon roller', 'steel roller', 'ball bearing roller', '10 ball', '11 ball', '13 ball', 'quiet rollers'], label: 'Rollers' },
                'tracks': { keywords: ['track', 'vertical track', 'horizontal track', 'curved track', 'track system'], label: 'Tracks' },
                'remote_keypad': { keywords: ['remote', 'keypad', 'transmitter', 'garage remote', 'wireless keypad', 'clicker'], label: 'Remotes & Keypads' }
            },
            
            tableColumns: [
                { id: 'customerName', label: 'Customer', sortable: true, render: (value) => value },
                { id: 'customerType', label: 'Type', sortable: true, render: (value) => `<span class="customer-type type-${value.toLowerCase()}">${value}</span>` },
                { id: 'primaryService', label: 'Primary Service', sortable: true, render: (value) => value ? `<span class="service-tag">${value}</span>` : '' },
                { id: 'products', label: 'Products', sortable: false, render: (value) => value.map(p => `<span class="product-tag">${p}</span>`).join('') },
                { id: 'city', label: 'City', sortable: true, render: (value) => value || '' },
                { id: 'totalJobs', label: 'Jobs', sortable: true, render: (value) => value },
                { id: 'jobNumbers', label: 'Job #s', sortable: false, render: (value) => {
                    const links = value.slice(0, 3).map(jobNum => 
                        `<a href="#" class="job-link" title="Job #${jobNum}">${jobNum}</a>`
                    ).join('');
                    return value.length > 3 ? links + ` +${value.length - 3} more` : links;
                }},
                { id: 'lastJobDate', label: 'Last Job', sortable: true, render: (value) => value || 'No completed' },
                { id: 'totalRevenue', label: 'Revenue', sortable: true, render: (value) => `$${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}` }
            ]
        };

        // ============================================================================
        // BUSINESS LOGIC LAYER - Single source of truth
        // ============================================================================
        
        class JobAnalysisService {
            
            // Raw keyword detection
            detectKeywords(lineItems, config) {
                let lineItemsStr = String(lineItems || '');
                const lineItemsLower = lineItemsStr.toLowerCase();
                
                const serviceTypes = [];
                const productCategories = [];
                
                // Detect service types
                for (const [key, serviceConfig] of Object.entries(config.serviceTypes)) {
                    for (const keyword of serviceConfig.keywords) {
                        if (lineItemsLower.includes(keyword)) {
                            if (!serviceTypes.includes(serviceConfig.label)) {
                                serviceTypes.push(serviceConfig.label);
                            }
                            break;
                        }
                    }
                }
                
                // Detect product categories
                for (const [key, productConfig] of Object.entries(config.productCategories)) {
                    for (const keyword of productConfig.keywords) {
                        if (lineItemsLower.includes(keyword)) {
                            if (!productCategories.includes(productConfig.label)) {
                                productCategories.push(productConfig.label);
                            }
                            break;
                        }
                    }
                }
                
                if (serviceTypes.length === 0) {
                    serviceTypes.push('General Service');
                }
                
                return { serviceTypes, productCategories };
            }
            
            // Business logic for job classification
            classifyJob(job, rawClassification) {
                const revenue = parseFloat(job['Total revenue ($)']) || 0;
                const lineItems = String(job['Line items'] || '').toLowerCase();
                
                let businessServiceTypes = [...rawClassification.serviceTypes];
                
                // Apply business rules
                if (revenue >= 1000 && this.isDoorInstallation(lineItems)) {
                    if (!businessServiceTypes.includes('Installation')) {
                        businessServiceTypes.push('Installation');
                    }
                }
                else if (revenue >= 300 && revenue < 1000 && this.isStandaloneOpener(lineItems)) {
                    if (!businessServiceTypes.includes('Operator/Opener')) {
                        businessServiceTypes.push('Operator/Opener');
                    }
                }
                
                const primaryService = this.determinePrimaryService(businessServiceTypes, revenue, lineItems);
                
                return {
                    serviceTypes: businessServiceTypes,
                    productCategories: rawClassification.productCategories,
                    primaryService: primaryService,
                    revenue: revenue
                };
            }
            
            isDoorInstallation(lineItems) {
                return lineItems.includes('door sale') || lineItems.includes('door clause') ||
                       lineItems.includes('wood door') || lineItems.includes('steel door') ||
                       lineItems.includes('aluminum door') || lineItems.includes('new door') ||
                       lineItems.includes('door install');
            }
            
            isStandaloneOpener(lineItems) {
                return (lineItems.includes('opener') || lineItems.includes('operator') || lineItems.includes('motor')) && 
                       !lineItems.includes('door sale') && !lineItems.includes('door clause');
            }
            
            determinePrimaryService(serviceTypes, revenue, lineItems) {
                if (revenue >= 1000 && this.isDoorInstallation(lineItems)) return 'Installation';
                if (serviceTypes.includes('Warranty')) return 'Warranty';
                if (serviceTypes.includes('Emergency')) return 'Emergency';
                if (revenue >= 300 && this.isStandaloneOpener(lineItems)) return 'Operator/Opener';
                if (serviceTypes.includes('Spring Service')) return 'Spring Service';
                if (serviceTypes.includes('Service/Repair')) return 'Service/Repair';
                if (serviceTypes.includes('Hardware')) return 'Hardware';
                if (serviceTypes.includes('Maintenance')) return 'Maintenance';
                return serviceTypes[0] || 'General Service';
            }
            
            // Customer aggregation
            aggregateCustomer(jobs) {
                const allServiceTypes = new Set();
                const allProductCategories = new Set();
                let totalRevenue = 0;
                let primaryServiceRevenue = {};
                
                jobs.forEach(job => {
                    const rawClassification = this.detectKeywords(job['Line items'], CONFIG);
                    const businessClassification = this.classifyJob(job, rawClassification);
                    
                    businessClassification.serviceTypes.forEach(st => allServiceTypes.add(st));
                    businessClassification.productCategories.forEach(pc => allProductCategories.add(pc));
                    
                    const primary = businessClassification.primaryService;
                    primaryServiceRevenue[primary] = (primaryServiceRevenue[primary] || 0) + businessClassification.revenue;
                    totalRevenue += businessClassification.revenue;
                });
                
                // Find highest revenue service
                let customerPrimaryService = 'General Service';
                let maxRevenue = 0;
                Object.entries(primaryServiceRevenue).forEach(([service, revenue]) => {
                    if (revenue > maxRevenue) {
                        maxRevenue = revenue;
                        customerPrimaryService = service;
                    }
                });
                
                return {
                    serviceTypes: Array.from(allServiceTypes),
                    productCategories: Array.from(allProductCategories),
                    primaryService: customerPrimaryService,
                    totalRevenue: totalRevenue
                };
            }
        }

        // ============================================================================
        // DATA LAYER
        // ============================================================================
        
        class DataProcessor {
            constructor() {
                this.analysisService = new JobAnalysisService();
                this.rawData = [];
                this.customerData = [];
                this.filteredData = [];
                this.totalRecordsCount = 0;
                this.residentialJobsCount = 0;
                this.detectedServiceTypes = new Set();
                this.detectedProductCategories = new Set();
            }
            
            processCSV(content) {
                const parsed = Papa.parse(content, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });
                
                this.totalRecordsCount = parsed.data.length;
                
                // Filter for Residential = Yes
                const residentialJobs = parsed.data.filter(row => {
                    const residential = row['Residential'];
                    return residential === 'Yes' || residential === 'yes' || residential === 'YES' || 
                           residential === true || residential === 'true' || residential === 'TRUE' ||
                           residential === 1 || residential === '1';
                });
                
                this.residentialJobsCount = residentialJobs.length;
                this.rawData = residentialJobs;
                
                this.detectedServiceTypes.clear();
                this.detectedProductCategories.clear();
                
                // Group by customer
                const grouped = _.groupBy(this.rawData, 'Client name');
                
                // Process each customer
                this.customerData = Object.entries(grouped).map(([clientName, jobs]) => {
                    const firstJob = jobs[0];
                    const lastCompletedJob = this.findLastCompletedJob(jobs);
                    
                    // Apply business logic
                    const businessResult = this.analysisService.aggregateCustomer(jobs);
                    
                    // Update detected categories for filtering
                    businessResult.serviceTypes.forEach(st => this.detectedServiceTypes.add(st));
                    businessResult.productCategories.forEach(pc => this.detectedProductCategories.add(pc));
                    
                    return {
                        customerName: clientName || 'Unknown',
                        customerType: this.classifyCustomerType(clientName, firstJob['Client email'], firstJob['Contractor'], jobs.length),
                        email: firstJob['Client email'] || '',
                        phone: firstJob['Client phone'] || '',
                        city: firstJob['Billing city'] || firstJob['Service city'] || firstJob['Job-Site City'] || '',
                        totalJobs: jobs.length,
                        jobNumbers: jobs.map(j => j['Job #']).filter(n => n),
                        lastJobDate: lastCompletedJob ? lastCompletedJob['Closed date'] : null,
                        totalRevenue: businessResult.totalRevenue,
                        year: this.extractYear(lastCompletedJob ? lastCompletedJob['Closed date'] : null),
                        month: this.extractMonth(lastCompletedJob ? lastCompletedJob['Closed date'] : null),
                        serviceTypes: businessResult.serviceTypes,
                        primaryService: businessResult.primaryService,
                        products: businessResult.productCategories,
                        rawJobs: jobs
                    };
                });
                
                this.filteredData = [...this.customerData];
                return this.customerData;
            }
            
            classifyCustomerType(customerName, email, contractorField, jobCount) {
                if (contractorField === 'Yes' || contractorField === 'yes') return 'Contractor';
                
                const contractorIndicators = ['llc', 'inc', 'corp', 'corporation', 'company', 'co.', 'construction', 'builders', 'contracting', 'contractor'];
                const nameLower = customerName.toLowerCase();
                
                for (const indicator of contractorIndicators) {
                    if (nameLower.includes(indicator)) return 'Contractor';
                }
                
                if (jobCount >= 2) {
                    const words = customerName.trim().split(' ');
                    const isLikelyPersonalName = words.length === 2 && !words.some(w => contractorIndicators.includes(w.toLowerCase()));
                    if (!isLikelyPersonalName) return 'Contractor';
                }
                
                return 'Homeowner';
            }
            
            applyFilters(filters) {
                if (!filters.customerType && !filters.serviceType && !filters.productCategory && 
                    !filters.year && !filters.month && !filters.city && !filters.minRevenue && !filters.minJobs) {
                    this.filteredData = [...this.customerData];
                    return this.filteredData;
                }
                
                // Filter at job level first, then re-aggregate
                const filteredJobs = [];
                
                this.rawData.forEach(job => {
                    const rawClassification = this.analysisService.detectKeywords(job['Line items'], CONFIG);
                    const businessResult = this.analysisService.classifyJob(job, rawClassification);
                    
                    const jobYear = this.extractYear(job['Closed date']);
                    const jobMonth = this.extractMonth(job['Closed date']);
                    const jobCity = job['Billing city'] || job['Service city'] || job['Job-Site City'] || '';
                    
                    let matches = true;
                    if (filters.serviceType && !businessResult.serviceTypes.includes(filters.serviceType)) matches = false;
                    if (filters.productCategory && !businessResult.productCategories.includes(filters.productCategory)) matches = false;
                    if (filters.year && jobYear !== filters.year) matches = false;
                    if (filters.month && jobMonth !== filters.month) matches = false;
                    if (filters.city && jobCity !== filters.city) matches = false;
                    
                    if (matches) filteredJobs.push(job);
                });
                
                // Re-aggregate by customer
                const groupedFilteredJobs = _.groupBy(filteredJobs, 'Client name');
                
                this.filteredData = Object.entries(groupedFilteredJobs).map(([clientName, jobs]) => {
                    const firstJob = jobs[0];
                    const lastCompletedJob = this.findLastCompletedJob(jobs);
                    
                    const businessResult = this.analysisService.aggregateCustomer(jobs);
                    const originalCustomer = this.customerData.find(c => c.customerName === clientName);
                    
                    const customerRecord = {
                        customerName: clientName || 'Unknown',
                        customerType: originalCustomer ? originalCustomer.customerType : 'Homeowner',
                        email: firstJob['Client email'] || '',
                        phone: firstJob['Client phone'] || '',
                        city: firstJob['Billing city'] || firstJob['Service city'] || firstJob['Job-Site City'] || '',
                        totalJobs: jobs.length,
                        jobNumbers: jobs.map(j => j['Job #']).filter(n => n),
                        lastJobDate: lastCompletedJob ? lastCompletedJob['Closed date'] : null,
                        totalRevenue: businessResult.totalRevenue,
                        year: this.extractYear(lastCompletedJob ? lastCompletedJob['Closed date'] : null),
                        month: this.extractMonth(lastCompletedJob ? lastCompletedJob['Closed date'] : null),
                        serviceTypes: businessResult.serviceTypes,
                        primaryService: businessResult.primaryService,
                        products: businessResult.productCategories,
                        rawJobs: jobs
                    };
                    
                    // Apply customer-level filters
                    if (filters.customerType && customerRecord.customerType !== filters.customerType) return null;
                    if (filters.minRevenue && customerRecord.totalRevenue < filters.minRevenue) return null;
                    if (filters.minJobs && customerRecord.totalJobs < filters.minJobs) return null;
                    
                    return customerRecord;
                }).filter(customer => customer !== null);
                
                return this.filteredData;
            }
            
            findLastCompletedJob(jobs) {
                const completed = jobs.filter(j => j['Closed date'] && j['Closed date'] !== '-' && j['Closed date'] !== '');
                if (completed.length === 0) return null;
                return completed.reduce((latest, job) => {
                    const jobDate = new Date(job['Closed date']);
                    const latestDate = new Date(latest['Closed date']);
                    return jobDate > latestDate ? job : latest;
                });
            }
            
            extractYear(dateStr) {
                if (!dateStr || dateStr === '-') return '';
                const parts = dateStr.split(' ');
                return parts.length === 3 ? parts[2] : '';
            }
            
            extractMonth(dateStr) {
                if (!dateStr || dateStr === '-') return '';
                const months = { 'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08', 'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12' };
                const parts = dateStr.split(' ');
                return parts.length === 3 ? months[parts[0]] || '' : '';
            }
            
            getStatistics() {
                const totalRevenue = this.filteredData.reduce((sum, c) => sum + c.totalRevenue, 0);
                const totalJobs = this.filteredData.reduce((sum, c) => sum + c.totalJobs, 0);
                
                return {
                    totalCustomers: this.filteredData.length,
                    totalJobs: totalJobs,
                    totalRevenue: totalRevenue,
                    avgRevenue: this.filteredData.length > 0 ? totalRevenue / this.filteredData.length : 0
                };
            }
            
            getFilterOptions() {
                return {
                    years: [...new Set(this.customerData.map(c => c.year).filter(y => y))].sort().reverse(),
                    cities: [...new Set(this.customerData.map(c => c.city).filter(c => c))].sort(),
                    serviceTypes: Array.from(this.detectedServiceTypes).sort(),
                    productCategories: Array.from(this.detectedProductCategories).sort()
                };
            }
            
            getCategoryAnalysis() {
                const serviceTypeBreakdown = {};
                const productBreakdown = {};
                
                this.filteredData.forEach(customer => {
                    customer.serviceTypes.forEach(st => {
                        if (!serviceTypeBreakdown[st]) serviceTypeBreakdown[st] = { count: 0, revenue: 0, customers: 0 };
                        serviceTypeBreakdown[st].customers++;
                        serviceTypeBreakdown[st].revenue += customer.totalRevenue;
                        serviceTypeBreakdown[st].count += customer.totalJobs;
                    });
                    
                    customer.products.forEach(p => {
                        if (!productBreakdown[p]) productBreakdown[p] = { count: 0, revenue: 0, customers: 0 };
                        productBreakdown[p].customers++;
                        productBreakdown[p].revenue += customer.totalRevenue;
                        productBreakdown[p].count += customer.totalJobs;
                    });
                });
                
                return { serviceTypeBreakdown, productBreakdown };
            }
        }

        // ============================================================================
        // UI LAYER
        // ============================================================================
        
        class UIRenderer {
            constructor(config) {
                this.config = config;
                this.sortColumn = null;
                this.sortDirection = 'asc';
            }
            
            renderTable(data) {
                const header = document.getElementById('tableHeader');
                header.innerHTML = '';
                const headerRow = document.createElement('tr');
                
                this.config.tableColumns.forEach((col) => {
                    const th = document.createElement('th');
                    th.textContent = col.label;
                    if (col.sortable) {
                        th.classList.add('sortable');
                        th.innerHTML = `${col.label} <span style="opacity: 0.7;">‚áÖ</span>`;
                        th.onclick = () => app.sort(col.id);
                    }
                    headerRow.appendChild(th);
                });
                header.appendChild(headerRow);
                
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    this.config.tableColumns.forEach(col => {
                        const td = document.createElement('td');
                        td.innerHTML = col.render(row[col.id]);
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }
            
            renderStats(stats) {
                const container = document.getElementById('statsGrid');
                container.innerHTML = '';
                
                const statConfigs = [
                    { id: 'totalCustomers', label: 'Total Customers', format: 'number' },
                    { id: 'totalJobs', label: 'Total Jobs', format: 'number' },
                    { id: 'totalRevenue', label: 'Total Revenue', format: 'currency' },
                    { id: 'avgRevenue', label: 'Avg per Customer', format: 'currency' }
                ];
                
                statConfigs.forEach(statConfig => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    
                    const value = stats[statConfig.id];
                    let formattedValue = value;
                    
                    if (statConfig.format === 'currency') {
                        formattedValue = `$${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
                    } else if (statConfig.format === 'number') {
                        formattedValue = value.toLocaleString();
                    }
                    
                    card.innerHTML = `
                        <div class="stat-value">${formattedValue}</div>
                        <div class="stat-label">${statConfig.label}</div>
                    `;
                    
                    container.appendChild(card);
                });
            }
            
            renderFilters(filterOptions, currentValues = {}) {
                document.getElementById('filtersContainer').style.display = 'block';
                
                const basicContainer = document.getElementById('basicFilters');
                basicContainer.innerHTML = '';
                
                basicContainer.appendChild(this.createSelect('customerType', 'Customer Type', [
                    { value: '', label: 'All Types' },
                    { value: 'Homeowner', label: 'Homeowners' },
                    { value: 'Contractor', label: 'Contractors' }
                ], currentValues.customerType));
                
                const minJobs = document.createElement('div');
                minJobs.className = 'filter-group';
                minJobs.innerHTML = `<label>Min Jobs</label><input type="number" id="minJobs" placeholder="0" min="0" value="${currentValues.minJobs || ''}">`;
                basicContainer.appendChild(minJobs);
                
                const minRevenue = document.createElement('div');
                minRevenue.className = 'filter-group';
                minRevenue.innerHTML = `<label>Min Revenue</label><input type="number" id="minRevenue" placeholder="0" min="0" value="${currentValues.minRevenue || ''}">`;
                basicContainer.appendChild(minRevenue);
                
                const categoryContainer = document.getElementById('categoryFilters');
                categoryContainer.innerHTML = '';
                
                const serviceOptions = [{ value: '', label: 'All Services' }].concat(filterOptions.serviceTypes.map(st => ({ value: st, label: st })));
                categoryContainer.appendChild(this.createSelect('serviceType', 'Service Type', serviceOptions, currentValues.serviceType));
                
                const productOptions = [{ value: '', label: 'All Products' }].concat(filterOptions.productCategories.map(pc => ({ value: pc, label: pc })));
                categoryContainer.appendChild(this.createSelect('productCategory', 'Product Category', productOptions, currentValues.productCategory));
                
                const timeLocationContainer = document.getElementById('timeLocationFilters');
                timeLocationContainer.innerHTML = '';
                
                const yearOptions = [{ value: '', label: 'All Years' }].concat(filterOptions.years.map(y => ({ value: y, label: y })));
                timeLocationContainer.appendChild(this.createSelect('year', 'Year', yearOptions, currentValues.year));
                
                const months = [
                    { value: '', label: 'All Months' }, { value: '01', label: 'January' }, { value: '02', label: 'February' }, { value: '03', label: 'March' },
                    { value: '04', label: 'April' }, { value: '05', label: 'May' }, { value: '06', label: 'June' }, { value: '07', label: 'July' },
                    { value: '08', label: 'August' }, { value: '09', label: 'September' }, { value: '10', label: 'October' }, { value: '11', label: 'November' }, { value: '12', label: 'December' }
                ];
                timeLocationContainer.appendChild(this.createSelect('month', 'Month', months, currentValues.month));
                
                const cityOptions = [{ value: '', label: 'All Cities' }].concat(filterOptions.cities.map(c => ({ value: c, label: c })));
                timeLocationContainer.appendChild(this.createSelect('city', 'City', cityOptions, currentValues.city));
                
                ['customerType', 'serviceType', 'productCategory', 'year', 'month', 'city'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => app.applyFilters());
                });
                ['minRevenue', 'minJobs'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => app.applyFilters());
                });
            }
            
            createSelect(id, label, options, currentValue = '') {
                const group = document.createElement('div');
                group.className = 'filter-group';
                
                const labelEl = document.createElement('label');
                labelEl.textContent = label;
                
                const select = document.createElement('select');
                select.id = id;
                
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    if (opt.value === currentValue) option.selected = true;
                    select.appendChild(option);
                });
                
                group.appendChild(labelEl);
                group.appendChild(select);
                return group;
            }
            
            renderCategorySummary(serviceTypes, productCategories) {
                const serviceChips = document.getElementById('serviceTypeChips');
                const productChips = document.getElementById('productCategoryChips');
                
                serviceChips.innerHTML = Array.from(serviceTypes).map(st => `<div class="category-chip">${st}</div>`).join('');
                productChips.innerHTML = Array.from(productCategories).slice(0, 10).map(pc => `<div class="category-chip">${pc}</div>`).join('');
                
                if (productCategories.size > 10) {
                    productChips.innerHTML += `<div class="category-chip">+${productCategories.size - 10} more</div>`;
                }
                
                document.getElementById('categoriesSummary').style.display = 'block';
            }
            
            showError(message) {
                document.getElementById('errorContainer').innerHTML = 
                    `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin-top: 20px;">${message}</div>`;
            }
            
            clearError() {
                document.getElementById('errorContainer').innerHTML = '';
            }
        }

        // ============================================================================
        // APPLICATION CONTROLLER
        // ============================================================================
        
        class ResidentialJobsAnalyzer {
            constructor() {
                this.dataProcessor = new DataProcessor();
                this.uiRenderer = new UIRenderer(CONFIG);
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
                uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) this.handleFile(e.dataTransfer.files[0]);
                });
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) this.handleFile(e.target.files[0]);
                });
            }
            
            handleFile(file) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    this.uiRenderer.showError('Please upload a CSV file.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => this.processData(e.target.result);
                reader.onerror = () => this.uiRenderer.showError('Error reading file.');
                reader.readAsText(file);
            }
            
            processData(csvContent) {
                try {
                    this.uiRenderer.clearError();
                    const data = this.dataProcessor.processCSV(csvContent);
                    
                    if (data.length === 0) {
                        this.uiRenderer.showError('No residential jobs found. The file must contain jobs with Residential = "Yes".');
                        return;
                    }
                    
                    document.getElementById('processingInfo').innerHTML = `
                        Processed <strong>${this.dataProcessor.totalRecordsCount.toLocaleString()}</strong> total records ‚Üí
                        Found <strong>${this.dataProcessor.residentialJobsCount.toLocaleString()}</strong> residential jobs ‚Üí
                        Grouped into <strong>${data.length}</strong> unique customers<br>
                        <small style="color: #6c757d;">Enhanced with 2024/2025 market research: ${this.dataProcessor.detectedServiceTypes.size} service types, ${this.dataProcessor.detectedProductCategories.size} product categories detected</small>
                    `;
                    
                    this.uiRenderer.renderCategorySummary(this.dataProcessor.detectedServiceTypes, this.dataProcessor.detectedProductCategories);
                    this.display();
                    
                    document.getElementById('uploadArea').style.display = 'none';
                    document.getElementById('analysisSection').classList.add('active');
                    
                } catch (error) {
                    this.uiRenderer.showError('Error processing CSV: ' + error.message);
                }
            }
            
            display() {
                const stats = this.dataProcessor.getStatistics();
                const filterOptions = this.dataProcessor.getFilterOptions();
                
                const currentValues = {};
                if (document.getElementById('customerType')) {
                    currentValues.customerType = document.getElementById('customerType').value;
                    currentValues.serviceType = document.getElementById('serviceType').value;
                    currentValues.productCategory = document.getElementById('productCategory').value;
                    currentValues.year = document.getElementById('year').value;
                    currentValues.month = document.getElementById('month').value;
                    currentValues.city = document.getElementById('city').value;
                    currentValues.minRevenue = document.getElementById('minRevenue').value;
                    currentValues.minJobs = document.getElementById('minJobs').value;
                }
                
                this.uiRenderer.renderStats(stats);
                this.uiRenderer.renderFilters(filterOptions, currentValues);
                this.uiRenderer.renderTable(this.dataProcessor.filteredData);
            }
            
            applyFilters() {
                const filters = {
                    customerType: document.getElementById('customerType').value,
                    serviceType: document.getElementById('serviceType').value,
                    productCategory: document.getElementById('productCategory').value,
                    year: document.getElementById('year').value,
                    month: document.getElementById('month').value,
                    city: document.getElementById('city').value,
                    minRevenue: parseFloat(document.getElementById('minRevenue').value) || 0,
                    minJobs: parseInt(document.getElementById('minJobs').value) || 0
                };
                
                this.dataProcessor.applyFilters(filters);
                this.display();
            }
            
            sort(columnId) {
                const column = CONFIG.tableColumns.find(c => c.id === columnId);
                if (!column || !column.sortable) return;
                
                if (this.uiRenderer.sortColumn === columnId) {
                    this.uiRenderer.sortDirection = this.uiRenderer.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.uiRenderer.sortColumn = columnId;
                    this.uiRenderer.sortDirection = 'asc';
                }
                
                this.dataProcessor.filteredData.sort((a, b) => {
                    let aVal = a[columnId];
                    let bVal = b[columnId];
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = (bVal || '').toLowerCase();
                    }
                    
                    if (this.uiRenderer.sortDirection === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
                
                this.uiRenderer.renderTable(this.dataProcessor.filteredData);
            }
            
            exportSummary() {
                const data = this.dataProcessor.filteredData.map(customer => ({
                    'Customer Name': customer.customerName,
                    'Customer Type': customer.customerType,
                    'Primary Service': customer.primaryService,
                    'All Services': customer.serviceTypes.join(', '),
                    'Products': customer.products.join(', '),
                    'City': customer.city,
                    'Email': customer.email,
                    'Phone': customer.phone,
                    'Total Jobs': customer.totalJobs,
                    'Job Numbers': customer.jobNumbers.join(', '),
                    'Last Job': customer.lastJobDate || 'No completed jobs',
                    'Total Revenue': customer.totalRevenue
                }));
                
                this.downloadCSV(data, 'Residential_Customer_Summary.csv');
            }
            
            exportDetailed() {
                const detailedData = [];
                
                this.dataProcessor.filteredData.forEach(customer => {
                    customer.rawJobs.forEach(job => {
                        const rawClassification = this.dataProcessor.analysisService.detectKeywords(job['Line items'], CONFIG);
                        const businessResult = this.dataProcessor.analysisService.classifyJob(job, rawClassification);
                        
                        detailedData.push({
                            'Customer Name': customer.customerName,
                            'Customer Type': customer.customerType,
                            'Service Types': businessResult.serviceTypes.join(', '),
                            'Products': businessResult.productCategories.join(', '),
                            'City': customer.city,
                            'Email': customer.email,
                            'Phone': customer.phone,
                            'Job #': job['Job #'],
                            'Created Date': job['Created date'],
                            'Closed Date': job['Closed date'] || 'Not closed',
                            'Line Items': job['Line items'],
                            'Revenue': parseFloat(job['Total revenue ($)']) || 0
                        });
                    });
                });
                
                this.downloadCSV(detailedData, 'Residential_Detailed_Report.csv');
            }
            
            showCategoryAnalysis() {
                const analysis = this.dataProcessor.getCategoryAnalysis();
                
                let message = 'Enhanced Category Analysis\n\n';
                message += 'Service Types:\n';
                Object.entries(analysis.serviceTypeBreakdown)
                    .sort((a, b) => b[1].revenue - a[1].revenue)
                    .forEach(([type, data]) => {
                        message += `${type}: ${data.customers} customers, ${data.count} jobs, $${data.revenue.toFixed(2)}\n`;
                    });
                
                message += '\nProduct Categories:\n';
                Object.entries(analysis.productBreakdown)
                    .sort((a, b) => b[1].revenue - a[1].revenue)
                    .slice(0, 10)
                    .forEach(([product, data]) => {
                        message += `${product}: ${data.customers} customers, ${data.count} jobs, $${data.revenue.toFixed(2)}\n`;
                    });
                
                alert(message);
            }
            
            downloadCSV(data, filename) {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            reset() {
                document.getElementById('uploadArea').style.display = 'block';
                document.getElementById('analysisSection').classList.remove('active');
                document.getElementById('fileInput').value = '';
                document.getElementById('categoriesSummary').style.display = 'none';
                document.getElementById('filtersContainer').style.display = 'none';
                this.dataProcessor = new DataProcessor();
                this.uiRenderer.clearError();
            }
        }

        // Initialize application
        const app = new ResidentialJobsAnalyzer();
    </script>
</body>
</html>