<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wood Door Customer Analysis Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #8B4513;
            background: #fff8f0;
        }
        
        .upload-area.dragover {
            border-color: #D2691E;
            background: #fff8f0;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .analysis-section {
            display: none;
        }
        
        .analysis-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #8B4513;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            user-select: none;
        }
        
        th.sortable {
            cursor: pointer;
        }
        
        th.sortable:hover {
            background: linear-gradient(135deg, #A0522D 0%, #DEB887 100%);
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .customer-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .type-homeowner {
            background: #d1f2eb;
            color: #0f5132;
        }
        
        .type-contractor {
            background: #fff3cd;
            color: #856404;
        }
        
        .job-link {
            color: #8B4513;
            text-decoration: none;
            margin-right: 6px;
            padding: 2px 6px;
            background: #fff8f0;
            border: 1px solid #D2691E;
            border-radius: 3px;
            display: inline-block;
            transition: all 0.2s;
        }
        
        .job-link:hover {
            background: #8B4513;
            color: white;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö™ Residential Wood Door Customer Analysis</h1>
            <p>Upload your complete job report CSV - automatically filters for residential wood door jobs</p>
        </div>
        
        <div class="content">
            <!-- Upload Section -->
            <div class="upload-area" id="uploadArea">
                <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                <div style="font-size: 18px; margin-bottom: 10px;">Click or drag to upload your complete job report CSV</div>
                <div style="color: #6c757d; font-size: 14px;">Automatically filters for Residential = Yes, then finds wood door jobs</div>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            
            <!-- Analysis Section -->
            <div class="analysis-section" id="analysisSection">
                <!-- Statistics -->
                <div class="stats-grid" id="statsGrid"></div>
                
                <!-- Filters -->
                <div class="filters" id="filtersContainer"></div>
                
                <!-- Action Buttons -->
                <div class="buttons">
                    <button class="btn btn-primary" onclick="app.exportSummary()">üì• Export Summary</button>
                    <button class="btn btn-primary" onclick="app.exportDetailed()">üìä Export Detailed Report</button>
                    <button class="btn btn-secondary" onclick="app.reset()">üîÑ Upload New File</button>
                </div>
                
                <!-- Data Table -->
                <div class="table-container">
                    <table id="dataTable">
                        <thead id="tableHeader"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Error Display -->
            <div id="errorContainer"></div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION - Easy to modify columns and business rules
        // ============================================================================
        
        const CONFIG = {
            // Define table columns - easy to add/remove/reorder
            tableColumns: [
                { 
                    id: 'customerName', 
                    label: 'Customer Name', 
                    sortable: true,
                    render: (value) => value
                },
                { 
                    id: 'customerType', 
                    label: 'Type', 
                    sortable: true,
                    render: (value) => `<span class="customer-type type-${value.toLowerCase()}">${value}</span>`
                },
                { 
                    id: 'city', 
                    label: 'City', 
                    sortable: true,
                    render: (value) => value || ''
                },
                { 
                    id: 'email', 
                    label: 'Email', 
                    sortable: false,
                    render: (value) => value || ''
                },
                { 
                    id: 'phone', 
                    label: 'Phone', 
                    sortable: false,
                    render: (value) => value || ''
                },
                { 
                    id: 'totalJobs', 
                    label: 'Jobs', 
                    sortable: true,
                    render: (value) => value
                },
                { 
                    id: 'jobNumbers', 
                    label: 'Job Numbers', 
                    sortable: false,
                    render: (value) => {
                        return value.map(jobNum => 
                            `<a href="https://secure.getjobber.com/work_orders/${jobNum}" 
                                target="_blank" class="job-link" 
                                title="View Job #${jobNum}">${jobNum}</a>`
                        ).join(' ');
                    }
                },
                { 
                    id: 'lastJobDate', 
                    label: 'Last Job', 
                    sortable: true,
                    render: (value) => value || 'No completed jobs'
                },
                { 
                    id: 'totalRevenue', 
                    label: 'Revenue', 
                    sortable: true,
                    render: (value) => `$${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`
                }
            ],
            
            // Statistics to display
            stats: [
                { id: 'totalCustomers', label: 'Total Customers', format: 'number' },
                { id: 'totalJobs', label: 'Wood Door Jobs', format: 'number' },
                { id: 'totalRevenue', label: 'Total Revenue', format: 'currency' },
                { id: 'avgRevenue', label: 'Avg per Customer', format: 'currency' }
            ],
            
            // Filters configuration
            filters: [
                { id: 'customerType', label: 'Customer Type', type: 'select' },
                { id: 'year', label: 'Year', type: 'select' },
                { id: 'month', label: 'Month', type: 'select' },
                { id: 'city', label: 'City', type: 'select' },
                { id: 'minRevenue', label: 'Min Revenue', type: 'number' }
            ]
        };
        
        // ============================================================================
        // BUSINESS LOGIC LAYER - Customer Classification Rules
        // ============================================================================
        
        class CustomerClassifier {
            constructor() {
                // Business name indicators
                this.contractorIndicators = [
                    'llc', 'inc', 'corp', 'corporation', 'company', 'co.',
                    'enterprises', 'partners', 'associates', 'group', 'holdings',
                    'construction', 'builders', 'contracting', 'contractor',
                    'development', 'renovations', 'restoration', 'improvements',
                    'homes', 'garage', 'doors', 'properties', 'realty',
                    'services', 'solutions', 'systems', 'supply',
                    'luxury', 'premium', 'quality', 'custom', 'elite', 'premier',
                    'professional', 'commercial', 'industrial'
                ];
                
                // Known contractor company names
                this.knownContractors = [
                    'whiting', 'turner', 'hoffman', 'capstone', 'blandford',
                    'norton', 'schultz', 'dnp', 'landmark', 'red moon',
                    'mark michael', 'ascend'
                ];
                
                // Email domains that indicate contractors
                this.contractorEmailDomains = [
                    'construction', 'builder', 'contractor', 'homes',
                    'properties', 'realty', 'enterprise', 'company'
                ];
                
                // Personal email providers
                this.genericEmailProviders = [
                    'gmail', 'yahoo', 'hotmail', 'outlook', 'aol', 
                    'icloud', 'msn', 'live', 'me', 'mac'
                ];
            }
            
            classify(customerName, email, contractorField, jobCount) {
                // Check contractor field first
                if (contractorField === 'Yes' || contractorField === 'yes') {
                    return 'Contractor';
                }
                
                const nameLower = customerName.toLowerCase();
                
                // Check for known contractors
                for (const known of this.knownContractors) {
                    if (nameLower.includes(known)) {
                        return 'Contractor';
                    }
                }
                
                // Check email domain
                if (email && this.isContractorEmail(email)) {
                    return 'Contractor';
                }
                
                // Check company name indicators
                for (const indicator of this.contractorIndicators) {
                    if (nameLower.includes(indicator)) {
                        return 'Contractor';
                    }
                }
                
                // 2+ jobs is a strong indicator of contractor
                // Homeowners rarely need multiple wood door projects
                if (jobCount >= 2) {
                    // For 2 jobs, check if name looks like a business
                    if (jobCount === 2) {
                        // Check for business patterns
                        if (this.hasBusinessNamePattern(customerName, jobCount)) {
                            return 'Contractor';
                        }
                        // Even simple names with 2 jobs are likely contractors
                        // unless it's clearly a personal name (First Last format)
                        const words = customerName.trim().split(' ');
                        const isLikelyPersonalName = words.length === 2 && 
                            !words.some(w => this.contractorIndicators.includes(w.toLowerCase()));
                        
                        if (!isLikelyPersonalName) {
                            return 'Contractor';
                        }
                    } else {
                        // 3+ jobs = definitely contractor
                        return 'Contractor';
                    }
                }
                
                // Check additional business naming patterns
                if (this.hasBusinessNamePattern(customerName, jobCount)) {
                    return 'Contractor';
                }
                
                return 'Homeowner';
            }
            
            isContractorEmail(email) {
                const emailLower = email.toLowerCase();
                const parts = emailLower.split('@');
                if (parts.length !== 2) return false;
                
                const domain = parts[1].split('.')[0];
                
                // Check if it's a business domain
                if (!this.genericEmailProviders.includes(domain)) {
                    for (const indicator of this.contractorEmailDomains) {
                        if (domain.includes(indicator)) {
                            return true;
                        }
                    }
                    // Non-generic email with multiple jobs = likely contractor
                    return false; // Will check job count separately
                }
                
                return false;
            }
            
            hasBusinessNamePattern(name, jobCount) {
                const words = name.trim().split(' ');
                const hasMultipleCaps = words.filter(w => w && w[0] === w[0].toUpperCase()).length >= 2;
                
                // Business symbols
                if ((name.includes('&') || name.includes('-')) && !name.includes(' and ')) {
                    return true;
                }
                
                // Names ending with business-like words
                const lastWord = words[words.length - 1]?.toLowerCase();
                const businessEndings = ['builders', 'construction', 'contracting', 
                    'homes', 'properties', 'services', 'doors', 'company'];
                if (businessEndings.includes(lastWord)) {
                    return true;
                }
                
                // Multiple capitalized words that don't look like a person's name
                if (hasMultipleCaps && words.length >= 3) {
                    // Three+ word names are often businesses
                    return true;
                }
                
                // Two word names that contain business indicators
                if (words.length === 2) {
                    for (const word of words) {
                        if (this.contractorIndicators.includes(word.toLowerCase())) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
        }
        
        // ============================================================================
        // DATA LAYER - Handle data processing and filtering
        // ============================================================================
        
        class DataProcessor {
            constructor() {
                this.classifier = new CustomerClassifier();
                this.rawData = [];
                this.customerData = [];
                this.filteredData = [];
            }
            
            processCSV(content) {
                const parsed = Papa.parse(content, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });
                
                // Store total count for reporting
                this.totalRecordsCount = parsed.data.length;
                
                // First filter for Residential = Yes
                const residentialJobs = parsed.data.filter(row => {
                    const residential = row['Residential'];
                    return residential === 'Yes' || residential === 'yes' || residential === 'YES';
                });
                
                this.residentialJobsCount = residentialJobs.length;
                console.log(`Found ${residentialJobs.length} residential jobs out of ${parsed.data.length} total jobs`);
                
                // Then filter residential jobs for wood door
                this.rawData = residentialJobs.filter(row => {
                    const lineItems = String(row['Line items'] || '').toLowerCase();
                    return lineItems.includes('wood door') || 
                           lineItems.includes('wood-door') || 
                           lineItems.includes('wooden door');
                });
                
                this.woodDoorJobsCount = this.rawData.length;
                console.log(`Found ${this.rawData.length} residential wood door jobs`);
                
                // Group by customer
                const grouped = _.groupBy(this.rawData, 'Client name');
                
                // Process each customer
                this.customerData = Object.entries(grouped).map(([clientName, jobs]) => {
                    const firstJob = jobs[0];
                    const lastCompletedJob = this.findLastCompletedJob(jobs);
                    const totalRevenue = jobs.reduce((sum, job) => 
                        sum + (parseFloat(job['Total revenue ($)']) || 0), 0);
                    
                    // Classify customer
                    const customerType = this.classifier.classify(
                        clientName,
                        firstJob['Client email'],
                        firstJob['Contractor'],
                        jobs.length
                    );
                    
                    return {
                        customerName: clientName || 'Unknown',
                        customerType: customerType,
                        email: firstJob['Client email'] || '',
                        phone: firstJob['Client phone'] || '',
                        city: firstJob['Billing city'] || firstJob['Service city'] || firstJob['Job-Site City'] || '',
                        totalJobs: jobs.length,
                        jobNumbers: jobs.map(j => j['Job #']).filter(n => n),
                        lastJobDate: lastCompletedJob ? lastCompletedJob['Closed date'] : null,
                        totalRevenue: totalRevenue,
                        year: this.extractYear(lastCompletedJob ? lastCompletedJob['Closed date'] : null),
                        month: this.extractMonth(lastCompletedJob ? lastCompletedJob['Closed date'] : null),
                        rawJobs: jobs
                    };
                });
                
                this.filteredData = [...this.customerData];
                return this.customerData;
            }
            
            findLastCompletedJob(jobs) {
                const completed = jobs.filter(j => 
                    j['Closed date'] && j['Closed date'] !== '-' && j['Closed date'] !== '');
                
                if (completed.length === 0) return null;
                
                return completed.reduce((latest, job) => {
                    const jobDate = new Date(job['Closed date']);
                    const latestDate = new Date(latest['Closed date']);
                    return jobDate > latestDate ? job : latest;
                });
            }
            
            extractYear(dateStr) {
                if (!dateStr || dateStr === '-') return '';
                const parts = dateStr.split(' ');
                return parts.length === 3 ? parts[2] : '';
            }
            
            extractMonth(dateStr) {
                if (!dateStr || dateStr === '-') return '';
                const months = {
                    'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                    'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                    'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                };
                const parts = dateStr.split(' ');
                return parts.length === 3 ? months[parts[0]] || '' : '';
            }
            
            applyFilters(filters) {
                this.filteredData = this.customerData.filter(customer => {
                    if (filters.customerType && customer.customerType !== filters.customerType) return false;
                    if (filters.year && customer.year !== filters.year) return false;
                    if (filters.month && customer.month !== filters.month) return false;
                    if (filters.city && customer.city !== filters.city) return false;
                    if (filters.minRevenue && customer.totalRevenue < filters.minRevenue) return false;
                    return true;
                });
                return this.filteredData;
            }
            
            getStatistics() {
                const totalRevenue = this.filteredData.reduce((sum, c) => sum + c.totalRevenue, 0);
                const totalJobs = this.filteredData.reduce((sum, c) => sum + c.totalJobs, 0);
                
                return {
                    totalCustomers: this.filteredData.length,
                    totalJobs: totalJobs,
                    totalRevenue: totalRevenue,
                    avgRevenue: this.filteredData.length > 0 ? totalRevenue / this.filteredData.length : 0
                };
            }
            
            getFilterOptions() {
                return {
                    years: [...new Set(this.customerData.map(c => c.year).filter(y => y))].sort().reverse(),
                    cities: [...new Set(this.customerData.map(c => c.city).filter(c => c))].sort()
                };
            }
        }
        
        // ============================================================================
        // VIEW LAYER - Handle UI rendering
        // ============================================================================
        
        class UIRenderer {
            constructor(config) {
                this.config = config;
                this.sortColumn = null;
                this.sortDirection = 'asc';
            }
            
            renderTable(data) {
                // Render header
                const header = document.getElementById('tableHeader');
                header.innerHTML = '';
                const headerRow = document.createElement('tr');
                
                this.config.tableColumns.forEach((col, index) => {
                    const th = document.createElement('th');
                    th.textContent = col.label;
                    if (col.sortable) {
                        th.classList.add('sortable');
                        th.innerHTML = `${col.label} <span style="opacity: 0.7;">‚áÖ</span>`;
                        th.onclick = () => app.sort(col.id);
                    }
                    headerRow.appendChild(th);
                });
                header.appendChild(headerRow);
                
                // Render body
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    this.config.tableColumns.forEach(col => {
                        const td = document.createElement('td');
                        td.innerHTML = col.render(row[col.id]);
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
            }
            
            renderStats(stats) {
                const container = document.getElementById('statsGrid');
                container.innerHTML = '';
                
                this.config.stats.forEach(statConfig => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    
                    const value = stats[statConfig.id];
                    let formattedValue = value;
                    
                    if (statConfig.format === 'currency') {
                        formattedValue = `$${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
                    } else if (statConfig.format === 'number') {
                        formattedValue = value.toLocaleString();
                    }
                    
                    card.innerHTML = `
                        <div class="stat-value">${formattedValue}</div>
                        <div class="stat-label">${statConfig.label}</div>
                    `;
                    
                    container.appendChild(card);
                });
            }
            
            renderFilters(filterOptions) {
                const container = document.getElementById('filtersContainer');
                container.innerHTML = '';
                
                // Customer Type Filter
                const typeFilter = this.createSelect('customerType', 'Customer Type', [
                    { value: '', label: 'All Types' },
                    { value: 'Homeowner', label: 'Homeowners' },
                    { value: 'Contractor', label: 'Contractors' }
                ]);
                container.appendChild(typeFilter);
                
                // Year Filter
                const yearOptions = [{ value: '', label: 'All Years' }].concat(
                    filterOptions.years.map(y => ({ value: y, label: y }))
                );
                container.appendChild(this.createSelect('year', 'Year', yearOptions));
                
                // Month Filter
                const months = [
                    { value: '', label: 'All Months' },
                    { value: '01', label: 'January' },
                    { value: '02', label: 'February' },
                    { value: '03', label: 'March' },
                    { value: '04', label: 'April' },
                    { value: '05', label: 'May' },
                    { value: '06', label: 'June' },
                    { value: '07', label: 'July' },
                    { value: '08', label: 'August' },
                    { value: '09', label: 'September' },
                    { value: '10', label: 'October' },
                    { value: '11', label: 'November' },
                    { value: '12', label: 'December' }
                ];
                container.appendChild(this.createSelect('month', 'Month', months));
                
                // City Filter
                const cityOptions = [{ value: '', label: 'All Cities' }].concat(
                    filterOptions.cities.map(c => ({ value: c, label: c }))
                );
                container.appendChild(this.createSelect('city', 'City', cityOptions));
                
                // Min Revenue Filter
                const minRevenue = document.createElement('div');
                minRevenue.className = 'filter-group';
                minRevenue.innerHTML = `
                    <label>Min Revenue</label>
                    <input type="number" id="minRevenue" placeholder="0" min="0">
                `;
                container.appendChild(minRevenue);
                
                // Add event listeners
                ['customerType', 'year', 'month', 'city'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => app.applyFilters());
                });
                document.getElementById('minRevenue').addEventListener('input', () => app.applyFilters());
            }
            
            createSelect(id, label, options) {
                const group = document.createElement('div');
                group.className = 'filter-group';
                
                const labelEl = document.createElement('label');
                labelEl.textContent = label;
                
                const select = document.createElement('select');
                select.id = id;
                
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    select.appendChild(option);
                });
                
                group.appendChild(labelEl);
                group.appendChild(select);
                return group;
            }
            
            showError(message) {
                document.getElementById('errorContainer').innerHTML = 
                    `<div class="error">‚ö†Ô∏è ${message}</div>`;
            }
            
            clearError() {
                document.getElementById('errorContainer').innerHTML = '';
            }
        }
        
        // ============================================================================
        // MAIN APPLICATION CONTROLLER
        // ============================================================================
        
        class WoodDoorAnalyzer {
            constructor() {
                this.dataProcessor = new DataProcessor();
                this.uiRenderer = new UIRenderer(CONFIG);
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.addEventListener('click', () => fileInput.click());
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) {
                        this.handleFile(e.dataTransfer.files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });
            }
            
            handleFile(file) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    this.uiRenderer.showError('Please upload a CSV file.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => this.processData(e.target.result);
                reader.onerror = () => this.uiRenderer.showError('Error reading file.');
                reader.readAsText(file);
            }
            
            processData(csvContent) {
                try {
                    this.uiRenderer.clearError();
                    const data = this.dataProcessor.processCSV(csvContent);
                    
                    if (data.length === 0) {
                        this.uiRenderer.showError('No residential wood door jobs found. The file must contain jobs with Residential = "Yes" and "wood door" in line items.');
                        return;
                    }
                    
                    this.display();
                    
                    // Show analysis section, hide upload
                    document.getElementById('uploadArea').style.display = 'none';
                    document.getElementById('analysisSection').classList.add('active');
                    
                } catch (error) {
                    this.uiRenderer.showError('Error processing CSV: ' + error.message);
                }
            }
            
            display() {
                const stats = this.dataProcessor.getStatistics();
                const filterOptions = this.dataProcessor.getFilterOptions();
                
                this.uiRenderer.renderStats(stats);
                this.uiRenderer.renderFilters(filterOptions);
                this.uiRenderer.renderTable(this.dataProcessor.filteredData);
            }
            
            applyFilters() {
                const filters = {
                    customerType: document.getElementById('customerType').value,
                    year: document.getElementById('year').value,
                    month: document.getElementById('month').value,
                    city: document.getElementById('city').value,
                    minRevenue: parseFloat(document.getElementById('minRevenue').value) || 0
                };
                
                this.dataProcessor.applyFilters(filters);
                this.display();
            }
            
            sort(columnId) {
                const column = CONFIG.tableColumns.find(c => c.id === columnId);
                if (!column || !column.sortable) return;
                
                // Toggle direction if same column
                if (this.uiRenderer.sortColumn === columnId) {
                    this.uiRenderer.sortDirection = this.uiRenderer.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.uiRenderer.sortColumn = columnId;
                    this.uiRenderer.sortDirection = 'asc';
                }
                
                // Sort data
                this.dataProcessor.filteredData.sort((a, b) => {
                    let aVal = a[columnId];
                    let bVal = b[columnId];
                    
                    // Handle different data types
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = (bVal || '').toLowerCase();
                    }
                    
                    if (this.uiRenderer.sortDirection === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
                
                this.uiRenderer.renderTable(this.dataProcessor.filteredData);
            }
            
            exportSummary() {
                const data = this.dataProcessor.filteredData.map(customer => ({
                    'Customer Name': customer.customerName,
                    'Customer Type': customer.customerType,
                    'City': customer.city,
                    'Email': customer.email,
                    'Phone': customer.phone,
                    'Total Jobs': customer.totalJobs,
                    'Job Numbers': customer.jobNumbers.join(', '),
                    'Last Job': customer.lastJobDate || 'No completed jobs',
                    'Total Revenue': customer.totalRevenue
                }));
                
                this.downloadCSV(data, 'Wood_Door_Customer_Summary.csv');
            }
            
            exportDetailed() {
                const detailedData = [];
                
                this.dataProcessor.filteredData.forEach(customer => {
                    customer.rawJobs.forEach(job => {
                        detailedData.push({
                            'Customer Name': customer.customerName,
                            'Customer Type': customer.customerType,
                            'City': customer.city,
                            'Email': customer.email,
                            'Phone': customer.phone,
                            'Job #': job['Job #'],
                            'Created Date': job['Created date'],
                            'Closed Date': job['Closed date'] || 'Not closed',
                            'Line Items': job['Line items'],
                            'Revenue': parseFloat(job['Total revenue ($)']) || 0
                        });
                    });
                });
                
                this.downloadCSV(detailedData, 'Wood_Door_Detailed_Report.csv');
            }
            
            downloadCSV(data, filename) {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            reset() {
                document.getElementById('uploadArea').style.display = 'block';
                document.getElementById('analysisSection').classList.remove('active');
                document.getElementById('fileInput').value = '';
                this.dataProcessor = new DataProcessor();
                this.uiRenderer.clearError();
            }
        }
        
        // Initialize application
        const app = new WoodDoorAnalyzer();
    </script>
</body>
</html>